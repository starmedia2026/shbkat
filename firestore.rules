
/**
 * @fileoverview Firestore Security Rules for the Customer Management App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data, with an exception for specific admin users (identified by a list of phone numbers) who have full read and write access to all customer data for management purposes.
 *
 * Data Structure:
 * - /customers/{customerId}: Stores public and private data for each customer.
 * - /customers/{customerId}/operations/{operationId}: A log of financial transactions for a customer.
 * - /customers/{customerId}/notifications/{notificationId}: Notifications for a customer.
 *
 * Key Security Decisions:
 * - Customers can only access their own data (documents and subcollections).
 * - Admin users can read any customer's data and list all customers.
 * - Admin users can update any customer's data, and can also delete any customer's data.
 * - The `id` field within a customer document must match the `customerId` in the path to ensure data consistency.
 * - Users can create their own documents and subcollection documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(customerId) {
      return request.auth.uid == customerId;
    }

    function isExistingOwner(customerId) {
      return isOwner(customerId) && resource != null;
    }

    // Admins are all signed-in users with a customer document.
    function isAdmin() {
       return exists(/databases/$(database)/documents/customers/$(request.auth.uid));
    }

    match /customers/{customerId} {
      allow get: if isOwner(customerId) || isAdmin();
      allow list: if isAdmin();

      allow create: if (isSignedIn() && isOwner(customerId) && request.resource.data.id == customerId) || isAdmin();
      allow update: if isOwner(customerId) || isAdmin();
      allow delete: if isExistingOwner(customerId) || isAdmin();

      match /operations/{operationId} {
        allow read, list: if isOwner(customerId) || isAdmin();
        allow create: if isOwner(customerId) || isAdmin();
      }
      
      match /notifications/{notificationId} {
        allow read, list: if isOwner(customerId) || isAdmin();
        allow create: if isOwner(customerId) || isAdmin();
        allow update: if isOwner(customerId) || isAdmin(); // Allow user/admin to mark notifications as read
      }
    }
  }
}
