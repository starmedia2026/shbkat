
/**
 * @fileoverview Firestore Security Rules for the Customer Management App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data, with an exception for a specific admin user (identified by a phone number) who has full read and write access to all customer data for management purposes.
 *
 * Data Structure:
 * - /customers/{customerId}: Stores public and private data for each customer.
 * - /customers/{customerId}/operations/{operationId}: A log of financial transactions for a customer.
 * - /customers/{customerId}/notifications/{notificationId}: Notifications for a customer.
 * - /customers/{customerId}/favorites/{networkId}: A user's favorite networks.
 * - /cards/{cardId}: Stores scratch card information.
 * - /settings/theme: Stores global theme settings.
 * - /adverts/{advertId}: Stores advertisement images for the home page carousel.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(customerId) {
      return request.auth.uid == customerId;
    }

    function isExistingOwner(customerId) {
      return isOwner(customerId) && resource != null;
    }

    // The admin is a specific user identified by their phone number/email.
    function isAdmin() {
       return isSignedIn() && request.auth.token.email == "770326828@shabakat.app";
    }
    
    function isNetworkOwner() {
        return isSignedIn() && get(/databases/$(database)/documents/customers/$(request.auth.uid)).data.accountType == "network-owner";
    }

    match /customers/{customerId} {
      // Allow any signed-in user to read any other customer's document.
      // This is necessary for the card purchase transaction to read the balances of the buyer, network owner, and admin.
      allow get: if isSignedIn();
      allow list: if isAdmin();

      // Any signed in user can create their own customer document.
      allow create: if isSignedIn() && isOwner(customerId) && request.resource.data.id == customerId;
      
      // An owner can update their own document, an admin can, or a signed-in user can update another user's document (for transfers/purchases).
      // This is safe because the transaction logic in the client code is what enforces the balance transfer rules.
      allow update: if isSignedIn();

      // An owner can delete their own document, or an admin can.
      allow delete: if isExistingOwner(customerId) || isAdmin();

      match /operations/{operationId} {
        allow read, list: if isOwner(customerId) || isAdmin();
        // Allow creating an operation for self, for another user (transfers), or allow admin/network-owner
        allow create: if isSignedIn() && (isOwner(customerId) || isNetworkOwner() || isAdmin());
        // Allow admin to update any operation (e.g. to confirm a withdrawal)
        allow update: if isAdmin();
      }
      
      match /notifications/{notificationId} {
        allow read, list: if isOwner(customerId) || isAdmin();
        // Allow creating a notification for self, for another user, or allow admin/network-owner
        allow create: if isSignedIn() && (isOwner(customerId) || isNetworkOwner() || isAdmin());
        // Allow user/admin to update notifications. The client-side code only updates the 'read' field.
        // This simpler rule is necessary for batch writes to function correctly.
        allow update: if isOwner(customerId) || isAdmin();
      }

      match /favorites/{networkId} {
        // User can only read and write to their own favorites subcollection.
        allow read, list, write, delete: if isOwner(customerId);
      }
    }
    
    // Rule for the collection group query on 'operations'
    match /{path=**}/operations/{operationId} {
      // Allow admin to read from any 'operations' subcollection.
      allow get, list: if isAdmin();
      // Allow admin to update any operation.
      allow update: if isAdmin();
    }

    match /cards/{cardId} {
        // Admin or Network owner can create, delete, and list cards.
        allow create, delete, list: if isAdmin() || isNetworkOwner();
        // Any signed-in user can read card data (needed to find an available card).
        allow read: if isSignedIn();
        // Allow updates for the 'purchase' transaction.
        // User must be signed in.
        // Card must be transitioning from 'available' to 'used'.
        // The 'usedBy' field must be the user's own UID.
        // Also allow admin or network owner to update cards.
        allow update: if (isSignedIn() && 
          request.resource.data.status == 'used' &&
          resource.data.status == 'available' &&
          request.resource.data.usedBy == request.auth.uid) || isAdmin() || isNetworkOwner();
    }

    match /settings/{docId} {
        // Allow anyone (including signed-out users) to read settings like theme.
        allow get: if true;
        // Only the admin can change the settings.
        allow write: if isAdmin();
    }

    match /adverts/{advertId} {
        // Allow anyone to see the adverts.
        allow get, list: if true;
        // Only admin can create, update, or delete adverts.
        allow write: if isAdmin();
    }
  }
}
